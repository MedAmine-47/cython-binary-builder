name: Build Cython Binary
on:
  workflow_dispatch:
    inputs:
      payload_url:
        required: true
        description: 'URL to download source payload'
      release_tag:
        required: true
        description: 'Release tag to upload to'
      is_encrypted:
        type: boolean
        required: true
        default: false
        description: 'Is payload encrypted?'
      base_image:
        type: choice
        description: 'Build Container'
        options: 
          - rockylinux/rockylinux:8
          - ubuntu:24.04
        default: rockylinux/rockylinux:8
      cpu_arch:
        required: false
        description: 'Target architectures (comma-separated)'
        default: 'skylake-avx512, cascadelake, x86-64'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    container:
      image: ${{ inputs.base_image }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install base dependencies
        run: |
          if command -v dnf > /dev/null 2>&1; then
            dnf install -y curl openssl binutils findutils
          else
            apt-get update && apt-get install -y curl openssl binutils findutils
          fi

      - name: Download and decrypt payload
        env:
          KEY: ${{ secrets.EPHEMERAL_KEY }}
        run: |
          curl -sL "${{ inputs.payload_url }}" -o dump.txt
          if [ "${{ inputs.is_encrypted }}" = "true" ]; then
            cat dump.txt | base64 -d | openssl enc -d -aes-256-cbc -pbkdf2 -pass pass:$KEY > myScript.py
          else
            mv dump.txt myScript.py
          fi

      - name: Install build tools
        run: |
          if command -v dnf > /dev/null 2>&1; then
            # --- Rocky Linux ---
            dnf install -y gcc-toolset-13-gcc gcc-toolset-13-gcc-c++ gcc-toolset-13-binutils python3.12 python3.12-devel

            source /opt/rh/gcc-toolset-13/enable
            echo "BASH_ENV=/opt/rh/gcc-toolset-13/enable" >> $GITHUB_ENV
            echo "CC=/opt/rh/gcc-toolset-13/root/usr/bin/gcc" >> $GITHUB_ENV
            echo "CXX=/opt/rh/gcc-toolset-13/root/usr/bin/g++" >> $GITHUB_ENV

            python3.12 -m ensurepip
            echo "PYTHON_BIN=python3.12" >> $GITHUB_ENV
            echo "PIP_ARGS=" >> $GITHUB_ENV
          else
            # --- Ubuntu ---
            apt-get install -y gcc g++ binutils python3-dev python3-pip

            echo "CC=/usr/bin/gcc" >> $GITHUB_ENV
            echo "CXX=/usr/bin/g++" >> $GITHUB_ENV

            echo "PYTHON_BIN=python3" >> $GITHUB_ENV
            echo "PIP_ARGS=--break-system-packages" >> $GITHUB_ENV
          fi

      - name: Install Python dependencies
        run: $PYTHON_BIN -m pip install cython setuptools $PIP_ARGS

      - name: Build
        shell: bash
        run: |
          IFS=',' read -ra ARCHS <<< "${{ inputs.cpu_arch }}"

          for ARCH in "${ARCHS[@]}"; do
            ARCH=$(echo "$ARCH" | xargs)
            export CPU_ARCH="$ARCH"
            $PYTHON_BIN setup.py build_ext --inplace --force

            for file in *.cpython-*.so; do
              if [ -f "$file" ]; then
                MOD_NAME="${file%%.*}"
                NEW_NAME="${MOD_NAME}-${ARCH}.so"
                mv "$file" "$NEW_NAME"
              fi
            done
          done

      # Safety Check: Explicitly verify binaries against GLIBC 2.28 (Target HPC version).
      # While Rocky 8 is naturally locked to 2.28, this safeguards against base image drift or accidental dependency upgrades.
      - name: Compatibility verification (GLIBC <= 2.28)
        if: inputs.base_image == 'rockylinux/rockylinux:8'
        run: |
          for file in *.so; do
            if objdump -T "$file" | grep -E 'GLIBC_([3-9]|2\.(2[9]|[3-9][0-9]))'; then
              echo "Binary requires GLIBC > 2.28: $file"
              exit 1
            fi
          done
          echo "All binaries compatible with GLIBC <= 2.28"

      - name: Strip debug symbols
        run: strip --strip-all *.so

      - name: Upload release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.release_tag }}
          files: "*.so"
          fail_on_unmatched_files: true
